-- 회원 테이블
CREATE TABLE MEMBER (
    MEMBER_ID VARCHAR2(50) PRIMARY KEY,
    PASSWORD VARCHAR2(200) NOT NULL,
    NAME VARCHAR2(100) NOT NULL,
    EMAIL VARCHAR2(100),
    PHONE VARCHAR2(20),
    ADDRESS VARCHAR2(200),
    ENABLED CHAR(1) DEFAULT '1',
    LOGIN_FAIL_COUNT NUMBER(2) DEFAULT 0,
    LAST_LOGIN_DATE DATE,
    PASSWORD_CHANGE_DATE DATE,
    CREATED_DATE DATE DEFAULT SYSDATE,
    MODIFIED_DATE DATE
);

-- 권한 테이블 (단순화)
CREATE TABLE MEMBER_ROLE (
    MEMBER_ID VARCHAR2(50),
    ROLE VARCHAR2(20),
    CONSTRAINT PK_MEMBER_ROLE PRIMARY KEY (MEMBER_ID, ROLE),
    CONSTRAINT FK_MEMBER_ROLE FOREIGN KEY (MEMBER_ID) 
        REFERENCES MEMBER(MEMBER_ID) ON DELETE CASCADE
);

-- 민원 테이블
CREATE TABLE COMPLAINT (
    COMPLAINT_ID NUMBER PRIMARY KEY,
    TITLE VARCHAR2(200) NOT NULL,
    CONTENT CLOB NOT NULL,
    MEMBER_ID VARCHAR2(50) NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'PENDING',
    PRIVATE_INFO_YN CHAR(1) DEFAULT 'N',
    CREATED_DATE DATE DEFAULT SYSDATE,
    MODIFIED_DATE DATE,
    COMPLETED_DATE DATE,
    CONSTRAINT FK_COMPLAINT_MEMBER FOREIGN KEY (MEMBER_ID) 
        REFERENCES MEMBER(MEMBER_ID)
);

-- 첨부파일 테이블
CREATE TABLE COMPLAINT_FILE (
    FILE_ID NUMBER PRIMARY KEY,
    COMPLAINT_ID NUMBER NOT NULL,
    ORIGINAL_FILENAME VARCHAR2(200) NOT NULL,
    STORED_FILENAME VARCHAR2(200) NOT NULL,
    FILE_SIZE NUMBER NOT NULL,
    FILE_TYPE VARCHAR2(100),
    CREATED_DATE DATE DEFAULT SYSDATE,
    CONSTRAINT FK_FILE_COMPLAINT FOREIGN KEY (COMPLAINT_ID) 
        REFERENCES COMPLAINT(COMPLAINT_ID) ON DELETE CASCADE
);

-- 민원처리이력 테이블
CREATE TABLE COMPLAINT_HISTORY (
    HISTORY_ID NUMBER PRIMARY KEY,
    COMPLAINT_ID NUMBER NOT NULL,
    STATUS VARCHAR2(20) NOT NULL,
    HANDLER_ID VARCHAR2(50) NOT NULL,
    PROCESS_COMMENT VARCHAR2(4000),
    CREATED_DATE DATE DEFAULT SYSDATE,
    CONSTRAINT FK_HISTORY_COMPLAINT FOREIGN KEY (COMPLAINT_ID) 
        REFERENCES COMPLAINT(COMPLAINT_ID) ON DELETE CASCADE,
    CONSTRAINT FK_HISTORY_HANDLER FOREIGN KEY (HANDLER_ID) 
        REFERENCES MEMBER(MEMBER_ID)
);

-- 시퀀스 생성
CREATE SEQUENCE SEQ_COMPLAINT_ID START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_FILE_ID START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_HISTORY_ID START WITH 1 INCREMENT BY 1;

-- 기본 데이터 입력
INSERT INTO MEMBER (MEMBER_ID, PASSWORD, NAME, EMAIL, ENABLED)
VALUES ('admin', '$2a$10$1w8BnYZx5IQgtTmKzYT5t.K.f8QS7vVdSY1Y0CgPDXkRv5FkHrmvK', '관리자', 'admin@system.com', '1');

INSERT INTO MEMBER_ROLE (MEMBER_ID, ROLE) VALUES ('admin', 'ADMIN');

--전체공개/비공개 여부 추가
ALTER TABLE COMPLAINT ADD PUBLIC_YN CHAR(1) DEFAULT 'Y' NOT NULL;